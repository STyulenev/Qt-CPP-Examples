set(
    CPACK_PACKAGE_NAME ${PROJECT_NAME}
    CACHE STRING "The resulting package name"
)

set(
    CPACK_PACKAGE_DESCRIPTION_SUMMARY "Simple C++ application"
    CACHE STRING "Package description for the package metadata"
)

include(GNUInstallDirs)

add_custom_command(
    OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/changelog.gz"
        COMMAND gzip -nck9 "${CMAKE_CURRENT_SOURCE_DIR}/changelog" > "${CMAKE_CURRENT_BINARY_DIR}/changelog.gz"
        WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
        DEPENDS "${CMAKE_CURRENT_SOURCE_DIR}/changelog"
        COMMENT "Compressing changelog")

add_custom_target(changelog ALL DEPENDS "${CMAKE_CURRENT_BINARY_DIR}/changelog.gz")
set(SOLIB $<TARGET_FILE:${DATALIB_TARGET}>)

set(CPACK_PACKAGE_VENDOR "...")

set(CPACK_VERBATIM_VARIABLES ON)

set(CPACK_PACKAGE_INSTALL_DIRECTORY ${CPACK_PACKAGE_NAME})
set(CPACK_OUTPUT_FILE_PREFIX "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
set(CPACK_STRIP_FILES ON)

set(
    CPACK_INSTALL_DEFAULT_DIRECTORY_PERMISSIONS
    OWNER_READ OWNER_WRITE OWNER_EXECUTE
    GROUP_READ GROUP_EXECUTE
    WORLD_READ WORLD_EXECUTE
)

set(CPACK_PACKAGE_VERSION_MAJOR ${PROJECT_VERSION_MAJOR})
set(CPACK_PACKAGE_VERSION_MINOR ${PROJECT_VERSION_MINOR})
set(CPACK_PACKAGE_VERSION_PATCH ${PROJECT_VERSION_PATCH})

set(CPACK_PACKAGE_CONTACT "tyulenev.i@yandex.ru")
set(CPACK_DEBIAN_PACKAGE_MAINTAINER "Sergey Tyulenev <${CPACK_PACKAGE_CONTACT}>")

set(CPACK_DEBIAN_FILE_NAME DEB-DEFAULT)
set(CPACK_COMPONENTS_GROUPING ALL_COMPONENTS_IN_ONE)
set(CPACK_DEB_COMPONENT_INSTALL ON)
set(CPACK_DEBIAN_PACKAGE_SHLIBDEPS ON)

set(CPACK_RESOURCE_FILE_README "${CMAKE_CURRENT_SOURCE_DIR}/../README.md")
set(CPACK_RESOURCE_FILE_LICENSE "${CMAKE_CURRENT_SOURCE_DIR}/../LICENSE")

include(CPackComponent)

set(CPACK_COMPONENTS_ALL runtime)
set(CPACK_COMPONENT_DEV_DEPENDS runtime)
set(CPACK_DEB_COMPONENT_INSTALL ON)
set(CPACK_DEBIAN_FILE_NAME DEB-DEFAULT)

set(CPACK_DEBIAN_RUNTIME_PACKAGE_NAME ${CPACK_PACKAGE_NAME}${SO_SUFF})

set(CPACK_PACKAGE_FILE_NAME  "${CPACK_PACKAGE_NAME}_${CPACK_PACKAGE_VERSION}_${CPACK_DEBIAN_PACKAGE_ARCHITECTURE}")
set(CMAKE_INSTALL_RUNTIME_DOCDIR "${CMAKE_INSTALL_DATAROOTDIR}/doc/${CPACK_DEBIAN_RUNTIME_PACKAGE_NAME}")
set(CPACK_PACKAGE_DESCRIPTION_FILE "${CMAKE_CURRENT_SOURCE_DIR}/README.Debian")
set(CPACK_DEBIAN_PACKAGE_CONTROL_EXTRA
    ${CMAKE_CURRENT_SOURCE_DIR}/preinst
    ${CMAKE_CURRENT_SOURCE_DIR}/postinst
    ${CMAKE_CURRENT_SOURCE_DIR}/prerm
    ${CMAKE_CURRENT_SOURCE_DIR}/postrm
    ${CMAKE_CURRENT_LIST_DIR}/triggers
)

message(STATUS "Components to pack: ${CPACK_COMPONENTS_ALL}")

include(CPack)

install(FILES "${CMAKE_CURRENT_BINARY_DIR}/changelog.gz"
    DESTINATION "${CMAKE_INSTALL_RUNTIME_DOCDIR}"
    PERMISSIONS ${DOC_PERMISSIONS_DEFAULT}
    COMPONENT runtime
)

install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/copyright"
    DESTINATION "${CMAKE_INSTALL_RUNTIME_DOCDIR}"
    PERMISSIONS ${DOC_PERMISSIONS_DEFAULT}
    COMPONENT runtime
)
